# @package _global_

defaults:
  - override /env: rsl_pc

image_size: [396, 640]
point_cloud_range: [-19.2, -19.2, -5, 19.2, 19.2, 5]
upsample_interpolate_neck: 2

voxel_size: [0.15, 0.15, 10]
xbound: [-19.2, 19.2, 0.15]
ybound: [-19.2, 19.2, 0.15]
zbound: [-5.0, 5.0, 10.0]
dbound: [1.0, 21, 0.4]
pointpillar_output_shape: [256, 256] # (x_max-x_min / x_res, y_max-y_min / y_res)
upsample_after_conv: 1
downsample_raw_ele: 1
name: anymal_debug/256_short_trial

return_n_pointclouds: 1
pointcloud_merge_threshold: 2
voxel_downsample: false
voxel_downsample_size: 0.4

batch_size: 6
num_workers: 12
training_steps: 16000
lr: 5e-4

persistent_workers: false
prefetch_factor: 2
pkl_cfg_file: dataset_config.pkl
use_images: false
use_lidar: false
use_raw_elevation: false
use_minz_pcl: false
use_gvom: true
use_minz_gvom: true
use_gvom_semantics: false
gvom_key: current_temporal_merged_points

target_shape_short: [256, 256]
gmr_resolution: 0.15
elevation_rescale: 0.04

freeze_backbones: false
sequence_length: 1
bptt_sequence_length: 1
use_temporal_fusion: false
test_full_sequence: false

logger:
  wandb:
    name: ${general.name}
    project: "bev_anymal"

general:
  name: ${name}
  dataset_dir: ${env.dataset_root_dir}
  result_dir: ${env.result_dir}
  model_path: ${general.result_dir}/${general.name}/${now:%Y-%m-%d}_${now:%H-%M-%S}
  tags: ["anymal", "debug"]
  train: false   # set false to skip model training
  test: true
  ckpt_path: /home/patelm/Data/results/anymal_debug/276_short_trial/2024-07-19_08-23-40/epoch=123-step=16000---last.ckpt  # simply provide checkpoint path to resume training
  seed: 41 # seed for random number generators in pytorch, numpy and python.random

trainer:
  _target_: lightning.pytorch.trainer.Trainer
  # precision: 16-mixed
  accumulate_grad_batches: 1
  fast_dev_run: false
  limit_train_batches: 1.0
  limit_val_batches: 1.0
  limit_test_batches: 1.0
  max_epochs: -1
  max_steps: ${training_steps}
  num_sanity_val_steps:  0
  check_val_every_n_epoch: 1
  accelerator: gpu
  detect_anomaly: false
  profiler: false  # 
  devices: 1  # All
  deterministic: false
  # strategy: str = None  # ddp # TODO

datamodule:
  _target_: perception_bev_learning.dataset.BEVDataModuleMulti
  dataloader:
    train_dataloader:
      batch_size: ${batch_size}
      num_workers: ${num_workers}
      persistent_workers: ${persistent_workers}
      prefetch_factor: ${prefetch_factor}
      shuffle: true
      drop_last: true
      pin_memory: true
    val_dataloader:
      batch_size: ${batch_size}
      num_workers: ${num_workers}
      persistent_workers: ${persistent_workers}
      prefetch_factor: ${prefetch_factor}
      shuffle: false
      drop_last: false
      pin_memory: true
    test_dataloader:
      batch_size: ${batch_size}
      num_workers: ${num_workers}
      persistent_workers: ${persistent_workers}
      prefetch_factor: ${prefetch_factor}
      shuffle: false
      drop_last: false
      pin_memory: true

  dataset:
    return_n_pointclouds: ${return_n_pointclouds}
    pointcloud_merge_threshold: ${pointcloud_merge_threshold}
    voxel_downsample: ${voxel_downsample}
    voxel_downsample_size: ${voxel_downsample_size}
    gvom_key: ${gvom_key}
    return_test: false

model:
  _target_: perception_bev_learning.lightning.LightningBEVMulti
  path: ${general.model_path}
  test_full_sequence: ${test_full_sequence} 
  sequence_length: ${sequence_length}
  batch_size: ${batch_size}

  visualizer:
    # Plotting Configuration
    train: 0
    val: 0
    test: -1
    plot_sequence: false
    # Plotting BEV Maps
    plot_all_risks: false
    plot_all_elevations: false
    plot_all_maps: true
    # Plotting Images
    plot_raw_images: true
    # Plotting Project data onto images
    project_gt_BEV_on_image: false
    project_pred_BEV_on_image: false
    # Generate Summary Dashboard
    plot_dashboard: true

  network:
    # specify the main network module (BevTravNet in our case)
    _target_: perception_bev_learning.models.fusion_models.BevTravNetMulti
    cfg_model:
      use_images: ${use_images}
      use_lidar: ${use_lidar}
      use_raw_elevation: ${use_raw_elevation}
      use_minz_pcl: ${use_minz_pcl}
      use_gvom: ${use_gvom}
      gmr_resolution: ${gmr_resolution}
      sequence_length: ${sequence_length}
      use_temporal_fusion: ${use_temporal_fusion}
      freeze_backbones: ${freeze_backbones}
      downsample_raw_ele: ${downsample_raw_ele}